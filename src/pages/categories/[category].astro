---
import { getCollection } from 'astro:content'
import Layout from '@/layouts/Layout.astro'
import formatDate from '@/utils/formatDate'

export async function getStaticPaths() {
  const posts = await getCollection('posts')
  const publishedPosts = posts.filter((post) => post.data.isPublish && !post.data.isDraft)

  // 获取所有唯一的分类
  const categories = [...new Set(publishedPosts.map((post) => post.data.category))]

  return categories.map((category) => ({
    params: { category },
    props: { category },
  }))
}

const { category } = Astro.props

// 获取该分类的所有文章
const posts = (await getCollection('posts'))
  .filter((post) => post.data.category === category && post.data.isPublish && !post.data.isDraft)
  .sort((a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime())
---

<Layout title={`刘浪的博客 - ${category} 分类`}>
  <main class='flex flex-col gap-12'>
    <div class='flex flex-col gap-4'>
      <div class='flex items-center gap-2 text-sm text-neutral-500'>
        <a href='/categories' class='hover:text-neutral-300'>分类</a>
        <span>/</span>
        <span class='text-neutral-100'>{category}</span>
      </div>
      <h1 class='text-2xl text-neutral-100'>{category}</h1>
      <p class='text-neutral-400'>共 {posts.length} 篇文章</p>
    </div>

    <article class='flex flex-col gap-4'>
      {
        posts.map((post) => (
          <a
            class='group flex flex-col gap-2 border-t border-neutral-700 py-4 transition-all hover:text-neutral-100'
            href={`/posts/${post.id}`}
            aria-label={`阅读文章：${post.data.title}`}
          >
            <div class='flex w-full items-center justify-between'>
              <h2 class='text-lg'>{post.data.title}</h2>

              <div class='flex flex-row items-center gap-4'>
                <p>{formatDate(post.data.publishedAt)}</p>
                <svg
                  width='18'
                  height='18'
                  viewBox='0 0 18 18'
                  fill='none'
                  class='transition-all duration-300 group-hover:translate-x-1'
                  aria-hidden='true'
                >
                  <path
                    d='M5.25 12.75L12.75 5.25'
                    stroke='#999999'
                    stroke-linecap='round'
                    stroke-linejoin='round'
                  />
                  <path
                    d='M5.25 5.25H12.75V12.75'
                    stroke='#999999'
                    stroke-linecap='round'
                    stroke-linejoin='round'
                  />
                </svg>
              </div>
            </div>
            <p>{post.data.description}</p>
          </a>
        ))
      }
    </article>

    <div class='flex justify-center'>
      <a
        href='/categories'
        class='rounded-md border border-neutral-700 px-6 py-2 text-neutral-400 transition-all hover:border-neutral-400 hover:text-neutral-100'
      >
        查看所有分类
      </a>
    </div>
  </main>
</Layout>
