---
import { type CollectionEntry, render } from 'astro:content'
import Layout from '@/layouts/Layout.astro'
import formatDate from '@/utils/formatDate'
import { getPostSlug, getPublishedPosts } from '@/utils/posts'

export async function getStaticPaths() {
  const publishedPosts = await getPublishedPosts()

  return publishedPosts.map((post) => ({
    params: { slug: getPostSlug(post) },
    props: { post },
  }))
}

type Props = {
  post: CollectionEntry<'posts'>
}

const { post } = Astro.props as Props
const { Content, headings } = await render(post)

// 只显示前3级目录
const renderHeadings = headings.filter((header) => header.depth <= 3)
---

<Layout title={post.data.title} description={post.data.description}>
  <main class='post mx-auto flex w-full flex-col gap-4'>
    <div class='mb-4'>
      <a
        href='/posts'
        class='text-neutral-400 hover:text-neutral-100 transition-colors inline-flex items-center gap-2'
      >
        <svg
          width='16'
          height='16'
          viewBox='0 0 24 24'
          fill='none'
          stroke='currentColor'
          stroke-width='2'
          stroke-linecap='round'
          stroke-linejoin='round'
        >
          <path d='M19 12H5M12 19l-7-7 7-7'></path>
        </svg>
        返回文章列表
      </a>
    </div>
    <header role='presentation'>
      <h1 class='text-md'>
        {post.data.title} - {formatDate(post.data.publishedAt)}
      </h1>
      <p class='italic'>{post.data.description}</p>
    </header>

    <div class='container'>
      <article class='flex-1'>
        <Content />
      </article>
      <div class='content-of-tables'>
        <nav class='nav'>
          <h2 class='contents'>目录</h2>
          {
            renderHeadings.map((heading) => (
              <a class:list={['nav-link', `depth-${heading.depth}`]} href={`#${heading.slug}`}>
                {heading.text}
              </a>
            ))
          }
        </nav>
      </div>
    </div>
  </main>
</Layout>

<style>
  .container {
    display: flex;
    gap: 64px;
  }

  .content-of-tables {
    grid-column: 3;
    grid-row: 1 / 200;
    align-self: start;
    width: 250px;
    margin-left: auto;
    margin-top: 0.125em;
    flex-shrink: 0;
    line-height: inherit;
    position: sticky;
    top: 8rem;
  }

  .nav {
    transition:
      opacity 0.4s,
      transform 0.7s cubic-bezier(0.17, 0.67, 0.54, 1);
    transform: translateX(0);
  }

  .contents {
    font-size: 1rem;
    margin-bottom: 16px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: hsl(210deg 25% 88%);
    line-height: 24px;
  }

  .nav-link {
    display: block;
    opacity: 0.7;
    text-decoration: none;
    transition: opacity 0.5s;
    font-size: 14px;
    line-height: 1.5;
    word-break: break-word;

    &:hover {
      opacity: 1;
      transition: opacity 0ms;
    }
  }

  .depth-2 {
    margin-top: 12px;
    font-size: 16px;
  }

  .depth-3 {
    margin-top: 4px;
    padding-left: 12px;
  }

  .depth-4 {
    margin-top: 4px;
    padding-left: 24px;
  }

  .active {
    opacity: 1;
    color: hsl(225deg 100% 75%);
    font-weight: 500;
  }

  @media screen and (max-width: 1080px) {
    .content-of-tables {
      display: none;
    }
  }
</style>

<script>
  const tocLinks = Array.from(document.querySelectorAll('.content-of-tables a'))
  const headingElements = Array.from(
    document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]'),
  )

  function setActiveHeading(activeHeadingId: string | undefined) {
    tocLinks.forEach((link) => {
      const href = link.getAttribute('href')?.slice(1)
      link.classList.toggle('active', href === activeHeadingId)
    })
  }

  function getActiveHeadingId(visibleHeadingIds: Set<string>): string | undefined {
    const firstVisibleHeading = headingElements.find((heading) => visibleHeadingIds.has(heading.id))

    if (firstVisibleHeading) {
      return firstVisibleHeading.id
    }

    let activeHeadingId = headingElements[0]?.id
    for (const heading of headingElements) {
      if (heading.getBoundingClientRect().top <= 120) {
        activeHeadingId = heading.id
        continue
      }
      break
    }

    return activeHeadingId
  }

  if (tocLinks.length !== 0 && headingElements.length !== 0) {
    const visibleHeadingIds = new Set<string>()

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const headingId = entry.target.id
          if (entry.isIntersecting) {
            visibleHeadingIds.add(headingId)
          } else {
            visibleHeadingIds.delete(headingId)
          }
        })

        setActiveHeading(getActiveHeadingId(visibleHeadingIds))
      },
      {
        rootMargin: '-100px 0px -65% 0px',
        threshold: [0, 1],
      },
    )

    headingElements.forEach((heading) => observer.observe(heading))
    setActiveHeading(getActiveHeadingId(visibleHeadingIds))
  }
</script>
